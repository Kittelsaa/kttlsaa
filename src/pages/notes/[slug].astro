---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import NoteLayout from '../../layouts/NoteLayout.astro';
import PageWrapper from '../../components/layouts/PageWrapper.astro';
import GrowthIcon from '../../components/GrowthIcon.astro';
import Backlinks from '../../components/Backlinks.astro';
import OutboundLinks from '../../components/OutboundLinks.astro';
import { findBacklinks, getOutboundLinks } from '../../utils/noteUtils.js';

export async function getStaticPaths() {
  const notes = await getCollection('notes');
  
  return notes.map(note => {
    if (!note.slug) {
      console.warn(`Note with title "${note.data.title}" has no slug`);
      return null;
    }
    
    return {
      params: { slug: note.slug },
      props: { note }
    };
  }).filter(Boolean);
}

const { slug } = Astro.params;
if (!slug) {
  return Astro.redirect('/404');
}

const { note } = Astro.props;

// Use a try-catch block to handle potential MDX rendering errors
let Content;
try {
  const rendered = await note.render();
  Content = rendered.Content;
} catch (error) {
  console.error(`Error rendering note ${slug}:`, error);
  return Astro.redirect('/500?error=rendering-failed');
}

// Get backlinks and outbound links
const backlinks = await findBacklinks(note.slug, 1) || [];
const outboundLinks = await getOutboundLinks(note, 1) || [];
---

<NoteLayout frontmatter={note.data} backlinks={backlinks}>
  <div class="note-main-content">
    <Content />
  </div>
  
  <div class="note-connections">
    {outboundLinks.length > 0 && (
      <OutboundLinks links={outboundLinks} />
    )}
  </div>
</NoteLayout>

<style>
  .note-main-content {
    margin-bottom: var(--space-xl);
  }
  
  .note-connections {
    margin-top: var(--space-xl);
    padding-top: var(--space-m);
    border-top: 1px solid var(--color-border);
  }
</style>


